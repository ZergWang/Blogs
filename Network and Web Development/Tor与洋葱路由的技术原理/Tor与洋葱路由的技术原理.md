# 洋葱路由
## 简介
当前广泛使用的HTTPS技术已经可以保证通信的保密性，但无法保证匿名性。通信双方传输的具体信息无法被第三者获知。但是，若第三者或黑客获取了TLS握手消息，其中Server Name Indication字段仍会暴露通信双方的身份。而洋葱路由(Onion Routing)是一种匿名通信技术，该技术通过加密通信内容来保证保密性，并令消息通过多个自有的洋葱网络跃点（Hop）让第三方无法获知通信双方的真实身份，从而保证匿名性。

![](Tor与洋葱路由的技术原理_1.png)
如图所示，在通信过程中，消息在每个洋葱路由器上被不同的密钥层层加密，如果要获取消息本身，就需要像剥洋葱一样，对密文逐层解密。这就是洋葱路由的名字由来。

## 通信过程
使用洋葱路由技术进行通信的具体过程如下图所示：

![](Tor与洋葱路由的技术原理_2.png)

### Step 1：节点选择
首先，客户端在访问服务器前，需要从目录节点（directory node）中选择多个节点来构成本次访问的路由路径（该路径一般称为“chain”或者“circuit”）。这些节点是分布在世界各地的服务器，由洋葱路由计划的志愿者维护。
### Step 2：准备阶段
假设为本次访问选择了三个节点（实际上的circuit可能由上百个节点构成）。这三个节点对应了三把密钥，每个节点只能知道自身对应的密钥，而客户端可以获知所有的密钥信息。客户端需要逐一使用这三把密钥对消息进行加密，加密过程如下图所示：

![](Tor与洋葱路由的技术原理_3.png)

从最远端节点对应的密钥开始加密，加密后再附上明文的节点地址。下文将解释此做法的目的。

三层加密后，密文就相当于一个包裹了三层“皮”的洋葱。加密完成后，客户端将密文发送给第一个节点（Node 1）。

### Step 3：节点跳转
每一个节点只知道自身对应的密钥。因此，当Node 1收到来自客户端的密文后，使用自身对应的密钥（Key 1）进行解密。通过上图可知，解密后会得到明文的Node 2的地址，但消息本身仍是加密的状态。因此Node 1将该密文发送给Node 2。

同理，Node 2也只知道Key 2。Node 2收到Node 1传来的密文后同样使用Key 2进行解密，发现了明文的Node 3地址和加密状态的消息，接着发送给Node 3。

Node 3收到后使用Key 3进行解密，解密后得到明文（“洋葱”的所有外皮均被剥开，露出了“明文”）。于是Node 3将明文发送给目标路由器。
### Step 4：消息回传

服务器将回复客户端的消息发送给Node 3。Node 3使用Key 3加密该消息后回传给Node 2；Node 2使用Key 2加密后传给Node 1；Node 1使用Key 1加密后回传给客户端。由于客户端知道所有密钥信息，因此依次使用Key 1、2、3解密消息后得到明文。

<br/><br/>

# Tor


<br/><br/>


# 参考资料
[Onion Routing](https://www.geeksforgeeks.org/onion-routing/)

[Onion routing: Definition, mechanism, and key features](https://nordvpn.com/zh/blog/onion-routing/)